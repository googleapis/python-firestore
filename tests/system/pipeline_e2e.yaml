data:
  books:
    book1:
      title: "The Hitchhiker's Guide to the Galaxy"
      author: "Douglas Adams"
      genre: "Science Fiction"
      published: 1979
      rating: 4.2
      tags:
        - comedy
        - space
        - adventure
      awards:
        hugo: true
        nebula: false
    book2:
      title: "Pride and Prejudice"
      author: "Jane Austen"
      genre: "Romance"
      published: 1813
      rating: 4.5
      tags:
        - classic
        - social commentary
        - love
      awards:
        none: true
    book3:
      title: "One Hundred Years of Solitude"
      author: "Gabriel García Márquez"
      genre: "Magical Realism"
      published: 1967
      rating: 4.3
      tags:
        - family
        - history
        - fantasy
      awards:
        nobel: true
        nebula: false
    book4:
      title: "The Lord of the Rings"
      author: "J.R.R. Tolkien"
      genre: "Fantasy"
      published: 1954
      rating: 4.7
      tags:
        - adventure
        - magic
        - epic
      awards:
        hugo: false
        nebula: false
    book5:
      title: "The Handmaid's Tale"
      author: "Margaret Atwood"
      genre: "Dystopian"
      published: 1985
      rating: 4.1
      tags:
        - feminism
        - totalitarianism
        - resistance
      awards:
        arthur c. clarke: true
        booker prize: false
    book6:
      title: "Crime and Punishment"
      author: "Fyodor Dostoevsky"
      genre: "Psychological Thriller"
      published: 1866
      rating: 4.3
      tags:
        - philosophy
        - crime
        - redemption
      awards:
        none: true
    book7:
      title: "To Kill a Mockingbird"
      author: "Harper Lee"
      genre: "Southern Gothic"
      published: 1960
      rating: 4.2
      tags:
        - racism
        - injustice
        - coming-of-age
      awards:
        pulitzer: true
    book8:
      title: "1984"
      author: "George Orwell"
      genre: "Dystopian"
      published: 1949
      rating: 4.2
      tags:
        - surveillance
        - totalitarianism
        - propaganda
      awards:
        prometheus: true
    book9:
      title: "The Great Gatsby"
      author: "F. Scott Fitzgerald"
      genre: "Modernist"
      published: 1925
      rating: 4.0
      tags:
        - wealth
        - american dream
        - love
      awards:
        none: true
    book10:
      title: "Dune"
      author: "Frank Herbert"
      genre: "Science Fiction"
      published: 1965
      rating: 4.6
      tags:
        - politics
        - desert
        - ecology
      awards:
        hugo: true
        nebula: true
tests:
  - description: selectSpecificFields
    pipeline:
      - Collection: books
      - Select:
          - title
          - author
      - Sort:
          - Ordering:
            - Field: author
            - ASCENDING
    assert_results:
      - title: "The Hitchhiker's Guide to the Galaxy"
        author: "Douglas Adams"
      - title: "The Great Gatsby"
        author: "F. Scott Fitzgerald"
      - title: "Dune"
        author: "Frank Herbert"
      - title: "Crime and Punishment"
        author: "Fyodor Dostoevsky"
      - title: "One Hundred Years of Solitude"
        author: "Gabriel García Márquez"
      - title: "1984"
        author: "George Orwell"
      - title: "To Kill a Mockingbird"
        author: "Harper Lee"
      - title: "The Lord of the Rings"
        author: "J.R.R. Tolkien"
      - title: "Pride and Prejudice"
        author: "Jane Austen"
      - title: "The Handmaid's Tale"
        author: "Margaret Atwood"
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - mapValue:
              fields:
                author:
                  fieldReferenceValue: author
                title:
                  fieldReferenceValue: title
          name: select
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: author
          name: sort
  - description: whereByMultipleConditions
    pipeline:
      - Collection: books
      - Where:
          - And:
              - Gt:
                  - Field: rating
                  - Constant: 4.5
              - Eq:
                  - Field: genre
                  - Constant: Science Fiction
    assert_results:
      - title: Dune
        author: Frank Herbert
        genre: Science Fiction
        published: 1965
        rating: 4.6
        tags:
          - politics
          - desert
          - ecology
        awards:
          hugo: true
          nebula: true
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - functionValue:
                  args:
                  - fieldReferenceValue: rating
                  - doubleValue: 4.5
                  name: gt
              - functionValue:
                  args:
                  - fieldReferenceValue: genre
                  - stringValue: Science Fiction
                  name: eq
              name: and
          name: where
  - description: whereByOrCondition
    pipeline:
      - Collection: books
      - Where:
          - Or:
              - Eq:
                  - Field: genre
                  - Constant: Romance
              - Eq:
                  - Field: genre
                  - Constant: Dystopian
      - Select:
        - title
      - Sort:
          - Ordering:
            - Field: title
            - ASCENDING
    assert_results:
      - title: "1984"
      - title: Pride and Prejudice
      - title: The Handmaid's Tale
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - functionValue:
                  args:
                  - fieldReferenceValue: genre
                  - stringValue: Romance
                  name: eq
              - functionValue:
                  args:
                  - fieldReferenceValue: genre
                  - stringValue: Dystopian
                  name: eq
              name: or
          name: where
        - args:
          - mapValue:
              fields:
                title:
                  fieldReferenceValue: title
          name: select
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: title
          name: sort
  - description: testPipelineWithOffsetAndLimit
    pipeline:
      - Collection: books
      - Sort:
          - Ordering:
            - Field: author
            - ASCENDING
      - Offset: 5
      - Limit: 3
      - Select:
        - title
        - author
    assert_results:
      - title: "1984"
        author: George Orwell
      - title: To Kill a Mockingbird
        author: Harper Lee
      - title: The Lord of the Rings
        author: J.R.R. Tolkien
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: author
          name: sort
        - args:
          - integerValue: '5'
          name: offset
        - args:
          - integerValue: '3'
          name: limit
        - args:
          - mapValue:
              fields:
                author:
                  fieldReferenceValue: author
                title:
                  fieldReferenceValue: title
          name: select
  - description: testArrayContains
    pipeline:
      - Collection: books
      - Where:
          - ArrayContains:
              - Field: tags
              - Constant: comedy
    assert_results:
      - title: The Hitchhiker's Guide to the Galaxy
        author: Douglas Adams
        awards:
          hugo: true
          nebula: false
        genre: Science Fiction
        published: 1979
        rating: 4.2
        tags: ["comedy", "space", "adventure"]
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - fieldReferenceValue: tags
              - stringValue: comedy
              name: array_contains
          name: where
  - description: testArrayContainsAny
    pipeline:
      - Collection: books
      - Where:
          - ArrayContainsAny:
            - Field: tags
            - - Constant: comedy
              - Constant: classic
      - Select:
        - title
      - Sort:
          - Ordering:
            - Field: title
            - ASCENDING
    assert_results:
      - title: Pride and Prejudice
      - title: The Hitchhiker's Guide to the Galaxy
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - fieldReferenceValue: tags
              - arrayValue:
                  values:
                  - stringValue: comedy
                  - stringValue: classic
              name: array_contains_any
          name: where
        - args:
          - mapValue:
              fields:
                title:
                  fieldReferenceValue: title
          name: select
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: title
          name: sort
  - description: testComparisonOperators
    pipeline:
      - Collection: books
      - Where:
          - And:
              - Gt:
                  - Field: rating
                  - Constant: 4.2
              - Lte:
                  - Field: rating
                  - Constant: 4.5
              - Neq:
                  - Field: genre
                  - Constant: Science Fiction
      - Select:
        - rating
        - title
      - Sort:
        - Ordering:
          - title
          - ASCENDING
    assert_results:
      - rating: 4.3
        title: Crime and Punishment
      - rating: 4.3
        title: One Hundred Years of Solitude
      - rating: 4.5
        title: Pride and Prejudice
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - functionValue:
                  args:
                  - fieldReferenceValue: rating
                  - doubleValue: 4.2
                  name: gt
              - functionValue:
                  args:
                  - fieldReferenceValue: rating
                  - doubleValue: 4.5
                  name: lte
              - functionValue:
                  args:
                  - fieldReferenceValue: genre
                  - stringValue: Science Fiction
                  name: neq
              name: and
          name: where
        - args:
          - mapValue:
              fields:
                rating:
                  fieldReferenceValue: rating
                title:
                  fieldReferenceValue: title
          name: select
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: title
          name: sort
  - description: testLogicalOperators
    pipeline:
      - Collection: books
      - Where:
          - Or:
              - And:
                  - Gt:
                      - Field: rating
                      - Constant: 4.5
                  - Eq:
                      - Field: genre
                      - Constant: Science Fiction
              - Lt:
                  - Field: published
                  - Constant: 1900
      - Select:
          - title
      - Sort:
        - Ordering:
          - Field: title
          - ASCENDING
    assert_results:
      - title: Crime and Punishment
      - title: Dune
      - title: Pride and Prejudice
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - functionValue:
                  args:
                  - functionValue:
                      args:
                      - fieldReferenceValue: rating
                      - doubleValue: 4.5
                      name: gt
                  - functionValue:
                      args:
                      - fieldReferenceValue: genre
                      - stringValue: Science Fiction
                      name: eq
                  name: and
              - functionValue:
                  args:
                  - fieldReferenceValue: published
                  - integerValue: '1900'
                  name: lt
              name: or
          name: where
        - args:
          - mapValue:
              fields:
                title:
                  fieldReferenceValue: title
          name: select
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: ascending
                expression:
                  fieldReferenceValue: title
          name: sort
  - description: testNestedFields
    pipeline:
      - Collection: books
      - Where:
          - Eq:
              - Field: awards.hugo
              - Constant: true
      - Sort:
          - Ordering:
            - Field: title
            - DESCENDING
      - Select:
          - title
          - Field: awards.hugo
    assert_results:
      - title: The Hitchhiker's Guide to the Galaxy
        awards.hugo: true
      - title: Dune
        awards.hugo: true
    assert_proto:
      pipeline:
        stages:
        - args:
          - referenceValue: /books
          name: collection
        - args:
          - functionValue:
              args:
              - fieldReferenceValue: awards.hugo
              - booleanValue: true
              name: eq
          name: where
        - args:
          - mapValue:
              fields:
                direction:
                  stringValue: descending
                expression:
                  fieldReferenceValue: title
          name: sort
        - args:
          - mapValue:
              fields:
                awards.hugo:
                  fieldReferenceValue: awards.hugo
                title:
                  fieldReferenceValue: title
          name: select